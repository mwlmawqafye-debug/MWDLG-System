<aside x-data="{
    collapsed: false,
    openCategories: ['إعداد النظام', 'البيانات الأساسية'],
    openGroups: []
}" class="flex flex-col h-full bg-white border-l border-gray-200 shadow-sm">

    <!-- Sidebar Header -->
    <div class="p-4 shrink-0 border-b flex items-center gap-3" :class="collapsed ? 'justify-center' : ''">
        <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-[var(--color-waqf-green)] text-white flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
        </div>
        <div x-show="!collapsed" class="overflow-hidden whitespace-nowrap">
            <h2 class="text-sm font-bold text-gray-800">نظام الوثائق الوقفية</h2>
        </div>
    </div>

    <!-- Scrollable Links Area -->
    <nav class="flex-grow min-h-0 overflow-y-auto p-2">
        <!-- Dashboard Link -->
        <a href="{{ url_for('index') }}"
           class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors"
           :class="[collapsed ? 'justify-center' : '', request.path == url_for('index') ? 'bg-gray-100 text-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900']">
            <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
            <span x-show="!collapsed" class="flex-1">لوحة القيادة</span>
        </a>

        <!-- Dynamic Collapsible Categories -->
        <div class="mt-4 space-y-2">
        {% for category_name, category_data in sidebar_structure.items() %}
            <div x-data="{}" class="space-y-1">
                <!-- Category Header -->
                <div @click="if (!collapsed) openCategories.includes('{{ category_name }}') ? openCategories = openCategories.filter(c => c !== '{{ category_name }}') : openCategories.push('{{ category_name }}')"
                     x-show="!collapsed"
                     class="flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-50 text-gray-600 hover:text-gray-900">
                    <h3 class="px-1 text-xs font-semibold uppercase tracking-wider">{{ category_name }}</h3>
                    <svg class="h-4 w-4 transition-transform" :class="openCategories.includes('{{ category_name }}') ? '' : '-rotate-90'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </div>

                <!-- Category Content -->
                <div x-show="!collapsed && openCategories.includes('{{ category_name }}')" class="space-y-1 ml-2 border-r-2 border-gray-100 pr-2">
                    {% for group in category_data.groups %}
                        <div x-data="{ flyout: false }" class="relative">
                            <!-- Group Header -->
                            <div @click="if (!collapsed) openGroups.includes('{{ group.name }}') ? openGroups = openGroups.filter(g => g !== '{{ group.name }}') : openGroups.push('{{ group.name }}')"
                                 @mouseenter="flyout = true" @mouseleave="flyout = false"
                                 class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors cursor-pointer"
                                 :class="[collapsed ? 'justify-center' : '', openGroups.includes('{{ group.name }}') ? 'bg-gray-100 text-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900']">
                                <span class="text-gray-500 flex-shrink-0">{{ group.modules[0].icon | safe if group.modules and group.modules[0].icon else '' }}</span>
                                <span x-show="!collapsed" class="flex-1">{{ group.name }}</span>
                                <svg x-show="!collapsed" class="h-4 w-4 transition-transform" :class="openGroups.includes('{{ group.name }}') ? '' : '-rotate-90'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                            <!-- Group Links (Expanded) -->
                            <div x-show="!collapsed && openGroups.includes('{{ group.name }}')" class="space-y-1 mt-1 border-r-2 border-gray-200 pr-2 mr-5">
                                {% for module in group.modules %}
                                <a href="{{ url_for('manage_entity', entity_slug=module.slug) if module.slug != 'identity-manager' else url_for('identity_manager') }}"
                                   class="block text-sm py-1.5 px-3 rounded-md transition-colors {% if request.path.endswith(module.slug) %}bg-blue-50 text-blue-600 font-semibold{% else %}text-gray-500 hover:text-gray-900 hover:bg-gray-50{% endif %}">
                                    {{ module.name_singular }}
                                </a>
                                {% endfor %}
                            </div>
                            <!-- Flyout Menu (Collapsed) -->
                            <div x-show="collapsed && flyout" x-transition class="absolute top-0 right-full w-48 bg-white shadow-lg rounded-md border z-50 mr-2 py-1">
                                <div class="font-bold text-sm px-3 py-2 text-gray-800">{{ group.name }}</div>
                                {% for module in group.modules %}
                                <a href="{{ url_for('manage_entity', entity_slug=module.slug) if module.slug != 'identity-manager' else url_for('identity_manager') }}" class="block text-sm px-3 py-1.5 text-gray-600 hover:bg-gray-100">{{ module.name_singular }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
        </div>
    </nav>

    <!-- Sidebar Footer -->
    <div class="p-2 shrink-0 border-t">
        <button @click="collapsed = !collapsed" class="w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900" :class="collapsed ? 'justify-center' : ''">
            <svg class="h-5 w-5 flex-shrink-0" :class="collapsed ? '' : 'transform -rotate-180'" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" /></svg>
            <span x-show="!collapsed" class="flex-1 text-right">طي القائمة</span>
        </button>
    </div>
</aside>